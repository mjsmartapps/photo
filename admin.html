<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJ SMART APPS - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-dark: #0f172a; --bg-card: #1e293b; --text-primary: #f8fafc; --text-secondary: #94a3b8; --accent-color: #3b82f6; --accent-hover: #2563eb; --glass-bg: rgba(30, 41, 59, 0.7); --glass-border: rgba(255, 255, 255, 0.1); --sidebar-width: 260px; }
        body { background-color: var(--bg-dark); color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-dark); } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at top right, #1e293b, #0f172a); }
        .login-container { width: 100%; max-width: 420px; padding: 40px; background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .sidebar { background: var(--bg-card); border-right: 1px solid var(--glass-border); height: 100vh; width: var(--sidebar-width); position: fixed; top: 0; left: 0; z-index: 1050; padding-top: 20px; transition: transform 0.3s ease-in-out; }
        .main-content-wrapper { margin-left: var(--sidebar-width); padding: 30px; min-height: 100vh; transition: margin-left 0.3s ease-in-out; }
        @media (max-width: 991.98px) { .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); } .main-content-wrapper { margin-left: 0; padding: 20px; } .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1040; } .sidebar-overlay.active { display: block; } }
        .sidebar-brand { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); padding: 0 20px 20px; border-bottom: 1px solid var(--glass-border); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .sidebar-link { display: flex; align-items: center; padding: 12px 20px; color: var(--text-secondary); text-decoration: none; transition: all 0.3s ease; border-left: 3px solid transparent; font-weight: 500; cursor: pointer; }
        .sidebar-link:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
        .sidebar-link.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); color: var(--accent-color); border-left-color: var(--accent-color); }
        .sidebar-link i { margin-right: 12px; font-size: 1.2rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--glass-border); border-radius: 16px; padding: 24px; height: 100%; position: relative; overflow: hidden; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(59, 130, 246, 0.3); }
        .stat-label { font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
        .stat-number { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); }
        .stat-icon { position: absolute; right: 20px; bottom: 20px; font-size: 3rem; opacity: 0.05; color: white; }
        .table-container { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--glass-border); overflow: hidden; }
        .table { margin-bottom: 0; }
        .table thead th { background: rgba(15, 23, 42, 0.5); color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; border-bottom: 1px solid var(--glass-border); padding: 16px; white-space: nowrap; }
        .table tbody td { background: transparent; color: var(--text-primary); border-bottom: 1px solid var(--glass-border); padding: 16px; vertical-align: middle; font-size: 0.95rem; white-space: nowrap; }
        .table tbody tr:hover td { background: rgba(255, 255, 255, 0.02); }
        .form-control { background: var(--bg-dark); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 12px; border-radius: 8px; }
        .form-control:focus { background: var(--bg-dark); border-color: var(--accent-color); color: var(--text-primary); }
        .btn-primary { background: var(--accent-color); border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-icon { width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text-secondary); transition: all 0.2s; }
        .btn-icon:hover { color: var(--text-primary); background: rgba(255,255,255,0.1); }
        .btn-icon.view:hover { color: #38bdf8; border-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
        .btn-icon.add:hover { color: #4ade80; border-color: #4ade80; background: rgba(74, 222, 128, 0.1); }
        .btn-icon.edit:hover { color: #facc15; border-color: #facc15; background: rgba(250, 204, 21, 0.1); }
        .btn-icon.delete:hover { color: #f87171; border-color: #f87171; background: rgba(248, 113, 113, 0.1); }
        .upload-drop-zone { border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; background: rgba(0,0,0,0.2); transition: all 0.2s; }
        .upload-drop-zone:hover { border-color: var(--accent-color); background: rgba(59, 130, 246, 0.05); }
        .modal-content { background: var(--bg-card); border: 1px solid var(--glass-border); color: var(--text-primary); }
        .modal-header { border-bottom: 1px solid var(--glass-border); }
        .modal-footer { border-top: 1px solid var(--glass-border); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; }
        .gallery-img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid var(--glass-border); }
        .hidden { display: none !important; }
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* New Toast Styles */
        .toast { background-color: var(--bg-card); border: 1px solid var(--glass-border); color: var(--text-primary); }
        .toast-header { background-color: rgba(15, 23, 42, 0.9); border-bottom: 1px solid var(--glass-border); color: var(--text-primary); }
    </style>
</head>
<body>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 2000;"></div>

    <div id="loginView" class="login-wrapper">
        <div class="login-container text-center">
            <h3 class="mb-4 fw-bold">Admin Portal</h3>
            <input type="email" id="emailInput" class="form-control mb-3" placeholder="Email">
            <input type="password" id="passInput" class="form-control mb-4" placeholder="Password">
            <button id="btnLogin" class="btn btn-primary w-100">Sign In</button>
            <p id="loginError" class="text-danger mt-3 small"></p>
        </div>
    </div>

    <div id="dashboardView" class="hidden">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="sidebar d-flex flex-column" id="adminSidebar">
            <div class="sidebar-brand">
                <i class="bi bi-camera-fill text-accent me-2"></i>MJ STUDIO
                <button class="btn btn-sm text-secondary d-lg-none ms-auto" onclick="toggleSidebar()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="flex-grow-1 px-3">
                <a onclick="switchView('home'); toggleSidebar()" id="nav-home" class="sidebar-link active mb-2"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
                <a onclick="switchView('clients'); toggleSidebar()" id="nav-clients" class="sidebar-link"><i class="bi bi-people-fill"></i> Clients</a>
            </div>
            <div class="p-3 border-top border-secondary border-opacity-10">
                <button id="btnLogout" class="btn btn-outline-danger w-100 btn-sm">Logout</button>
            </div>
        </div>

        <div class="main-content-wrapper">
            
            <button class="btn btn-dark d-lg-none mb-4 border border-secondary border-opacity-25" onclick="toggleSidebar()">
                <i class="bi bi-list me-2"></i>Menu
            </button>

            <div id="view-home" class="view-section active">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h2 class="fw-bold m-0">Dashboard Overview</h2>
                    <span class="badge bg-success bg-opacity-10 text-success">System Online</span>
                </div>
                <div class="row g-4">
                    <div class="col-md-4 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-label">Total Active Clients</div>
                            <div class="stat-number" id="totalClientsCount">0</div>
                            <i class="bi bi-people-fill stat-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="stat-card">
                            <div class="stat-label">Total Storage Used</div>
                            <div class="stat-number text-accent" id="totalStorageUsed">0 MB</div>
                            <i class="bi bi-hdd-network-fill stat-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-12">
                        <div class="stat-card">
                            <div class="stat-label">AI Status</div>
                            <div id="dashboardModelStatus" class="fs-4 mt-1 fw-bold text-warning">Loading...</div>
                            <i class="bi bi-cpu-fill stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-clients" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h2 class="fw-bold m-0">Client Management</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        <i class="bi bi-plus-lg me-2"></i>New Client
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Event</th>
                                    <th>Phone</th>
                                    <th>Images</th>
                                    <th>Size</th>
                                    <th style="min-width: 150px;">Actions</th>
                                    <th>Generated Links</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <tr><td colspan="8" class="text-center text-muted py-5">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="addClientModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">Create New Event</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-4">
                    <form id="addClientForm">
                        <div class="row g-3">
                            <div class="col-md-6"><label class="small text-secondary fw-bold">Date</label><input type="date" id="clientDate" class="form-control"></div>
                            <div class="col-md-6"><label class="small text-secondary fw-bold">Client Name</label><input type="text" id="clientName" class="form-control" placeholder="John Doe"></div>
                            <div class="col-md-6"><label class="small text-secondary fw-bold">Event Name</label><input type="text" id="eventName" class="form-control" placeholder="Wedding"></div>
                            <div class="col-md-6"><label class="small text-secondary fw-bold">Phone</label><input type="tel" id="clientPhone" class="form-control" placeholder="+91..."></div>
                        </div>
                        <div class="mt-4">
                            <label class="fw-bold text-accent mb-2"><i class="bi bi-images me-2"></i>Upload Photos</label>
                            <div class="upload-drop-zone" onclick="document.getElementById('clientPhotos').click()">
                                <i class="bi bi-cloud-arrow-up display-4 text-secondary opacity-50"></i>
                                <p class="text-muted mt-2 mb-0">Select photos or drag & drop</p>
                                <input type="file" id="clientPhotos" class="d-none" multiple accept="image/*">
                            </div>
                            <div id="fileCountLabel" class="text-center mt-2 text-info small"></div>
                        </div>
                        <div id="uploadProgressBox" class="mt-3" style="display:none;">
                            <div class="d-flex justify-content-between small mb-1"><span id="currentUploadFile">Initializing...</span><span id="uploadPercent">0%</span></div>
                            <div class="progress" style="height: 6px;"><div id="uploadProgressBar" class="progress-bar bg-accent" style="width: 0%"></div></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-light border-0" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="btnSaveClient" onclick="saveClient()">Create Event</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addMorePhotosModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">Add More Photos</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-4">
                    <p class="text-secondary small mb-3">Adding to: <span id="addMoreClientName" class="text-white fw-bold"></span></p>
                    <div class="upload-drop-zone" onclick="document.getElementById('addMoreInput').click()">
                        <i class="bi bi-plus-circle-dotted display-4 text-accent"></i>
                        <p class="text-white mt-2">Click to Add Photos</p>
                        <input type="file" id="addMoreInput" class="d-none" multiple accept="image/*">
                    </div>
                    <div id="addMoreCountLabel" class="text-center mt-2 text-info small"></div>
                    <div id="addMoreProgressBox" class="mt-3" style="display:none;">
                        <div class="progress" style="height: 6px;"><div id="addMoreProgressBar" class="progress-bar bg-accent" style="width: 0%"></div></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-light border-0" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary" id="btnAddMoreConfirm" onclick="confirmAddMore()" disabled>Upload</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editClientModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Details</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-4">
                    <form id="editClientForm">
                        <input type="hidden" id="editClientId">
                        <div class="mb-3"><label class="small text-secondary fw-bold">Name</label><input type="text" id="editClientName" class="form-control"></div>
                        <div class="mb-3"><label class="small text-secondary fw-bold">Event</label><input type="text" id="editEventName" class="form-control"></div>
                        <div class="mb-3"><label class="small text-secondary fw-bold">Date</label><input type="date" id="editClientDate" class="form-control"></div>
                        <div class="mb-3"><label class="small text-secondary fw-bold">Phone</label><input type="tel" id="editClientPhone" class="form-control"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="updateClient()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger bg-opacity-10 border-danger border-opacity-25">
                    <h5 class="modal-title text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Event</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p>Are you sure you want to delete this event? <br><span class="text-secondary small">This action cannot be undone. All photos and data will be permanently removed.</span></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-light border-0" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger" id="btnConfirmDelete">Yes, Delete Everything</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewGalleryModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div><h5 class="modal-title fw-bold">Full Gallery View</h5><p class="mb-0 text-muted small">ID: <span id="viewClientId"></span></p></div>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div id="galleryGrid" class="gallery-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, get, remove, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // *** CONFIGURATION ***
        const WORKER_URL = "https://your-worker-name.your-subdomain.workers.dev"; // Replace with your Worker URL

        const firebaseConfig = {
            apiKey: "AIzaSyB5jaPVkCwxXiMYhSn0uuW9QSMc-B5C9YY",
            authDomain: "mjsmartapps.firebaseapp.com",
            databaseURL: "https://mjsmartapps-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mjsmartapps",
            storageBucket: "mjsmartapps.firebasestorage.app",
            messagingSenderId: "1033240518010",
            appId: "1:1033240518010:web:930921011dda1bd56e0ac3",
            measurementId: "G-959VLQSHH2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // UI HELPERS
        function formatBytes(bytes) {
            if (!+bytes) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${parseFloat((bytes / Math.pow(1024, i)).toFixed(2))} ${sizes[i]}`;
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const bgClass = type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : 'bg-dark text-light border-light';
            const icon = type === 'success' ? 'bi-check-circle-fill' : type === 'danger' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill';
            
            const toastId = 'toast_' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${icon} me-2"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Cleanup DOM after toast hides
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        let activeAddClientId, activeAddClientName, editClientModalInstance, addMoreModalInstance, deleteModalInstance;
        let clientToDeleteId = null;

        document.addEventListener('DOMContentLoaded', () => {
             editClientModalInstance = new bootstrap.Modal(document.getElementById('editClientModal'));
             addMoreModalInstance = new bootstrap.Modal(document.getElementById('addMorePhotosModal'));
             deleteModalInstance = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
             
             document.getElementById('clientPhotos').addEventListener('change', function(){
                document.getElementById('fileCountLabel').innerText = this.files.length ? `${this.files.length} photos selected` : '';
             });
             document.getElementById('addMoreInput').addEventListener('change', function(){
                document.getElementById('addMoreCountLabel').innerText = this.files.length ? `${this.files.length} photos selected` : '';
                document.getElementById('btnAddMoreConfirm').disabled = !this.files.length;
             });

             // Setup Delete Confirm Button
             document.getElementById('btnConfirmDelete').addEventListener('click', async () => {
                 if(clientToDeleteId) {
                     await performDelete(clientToDeleteId);
                     deleteModalInstance.hide();
                     clientToDeleteId = null;
                 }
             });
        });

        window.toggleSidebar = () => {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        };

        window.switchView = (v) => {
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${v}`).classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('dashboardView').classList.remove('hidden');
                initClientsListener();
            } else {
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('loginView').classList.remove('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, document.getElementById('emailInput').value, document.getElementById('passInput').value)
                .catch(err => document.getElementById('loginError').innerText = err.message);
        });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
        ]).then(() => document.getElementById('dashboardModelStatus').innerHTML = '<span class="text-success">Active</span>');

        function initClientsListener() {
            onValue(ref(db, 'clients'), (snapshot) => {
                const tbody = document.getElementById('clientsTableBody');
                tbody.innerHTML = '';
                let globalTotalSize = 0;

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('totalClientsCount').innerText = Object.keys(data).length;

                    Object.entries(data).forEach(([key, client]) => {
                        const baseUrl = window.location.href.replace('admin.html', 'index.html').split('#')[0];
                        const aiLink = `${baseUrl}?eventId=${key}`;
                        const galleryLink = `${baseUrl}?eventId=${key}&view=all`;
                        
                        globalTotalSize += (client.totalSize || 0);

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><span class="text-white">${client.date}</span></td>
                            <td><span class="fw-bold text-white">${client.name}</span></td>
                            <td>${client.eventName}</td>
                            <td>${client.phone}</td>
                            <td class="text-center"><span class="badge bg-secondary bg-opacity-25 text-light">${client.totalImages || 0}</span></td>
                            <td class="font-monospace text-accent small">${formatBytes(client.totalSize || 0)}</td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button class="btn-icon view" onclick="viewClientGallery('${key}')" title="View Full Gallery"><i class="bi bi-eye"></i></button>
                                    <button class="btn-icon add" onclick="triggerAddMore('${key}', '${client.name}')" title="Add More Photos"><i class="bi bi-cloud-plus"></i></button>
                                    <button class="btn-icon edit" onclick="triggerEdit('${key}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                    <button class="btn-icon delete" onclick="prepareDelete('${key}')" title="Delete"><i class="bi bi-trash"></i></button>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                     <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${aiLink}')"><i class="bi bi-robot me-1"></i>AI Link</button>
                                     <button class="btn btn-sm btn-outline-info" onclick="copyToClipboard('${galleryLink}')"><i class="bi bi-grid me-1"></i>Gallery Link</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    document.getElementById('totalClientsCount').innerText = 0;
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary py-5">No active clients found.</td></tr>';
                }
                document.getElementById('totalStorageUsed').innerText = formatBytes(globalTotalSize);
            });
        }

        async function processAndUploadFiles(files, clientId, progBarId, statusId, percentId) {
            const progressBar = document.getElementById(progBarId);
            const statusLabel = document.getElementById(statusId);
            const percentLabel = document.getElementById(percentId);
            const fileArray = Array.from(files);
            let processedCount = 0;

            for (const file of fileArray) {
                statusLabel.innerText = `Processing: ${file.name}`;
                try {
                    const img = await faceapi.bufferToImage(file);
                    const detections = await faceapi.detectAllFaces(img).withFaceLandmarks().withFaceDescriptors();
                    const descriptors = detections.length > 0 ? detections.map(d => Array.from(d.descriptor)) : [];
                    
                    const fileKey = `gallery_photos/${clientId}/${Date.now()}_${file.name}`;
                    const response = await fetch(`${WORKER_URL}?key=${encodeURIComponent(fileKey)}`, {
                        method: 'PUT',
                        body: file
                    });

                    if(!response.ok) throw new Error("Upload failed");
                    
                    const result = await response.json();
                    const downloadURL = result.url;
                    
                    await push(ref(db, `gallery_photos/${clientId}`), {
                        url: downloadURL,
                        descriptors: descriptors,
                        size: file.size,
                        uploadedAt: Date.now()
                    });
                } catch (err) { console.error(err); }
                processedCount++;
                const percent = Math.round((processedCount / fileArray.length) * 100);
                if(progressBar) progressBar.style.width = `${percent}%`;
                if(percentLabel) percentLabel.innerText = `${percent}%`;
            }
        }

        window.saveClient = async () => {
            const date = document.getElementById('clientDate').value;
            const name = document.getElementById('clientName').value;
            const eventName = document.getElementById('eventName').value;
            const phone = document.getElementById('clientPhone').value;
            const fileInput = document.getElementById('clientPhotos');
            
            if(!date || !name || !eventName || !phone || fileInput.files.length === 0) {
                return showToast("Please fill all fields and select photos.", "danger");
            }

            document.getElementById('btnSaveClient').disabled = true;
            document.getElementById('uploadProgressBox').style.display = 'block';

            try {
                let batchSize = 0;
                Array.from(fileInput.files).forEach(f => batchSize += f.size);

                const newClientRef = push(ref(db, 'clients'));
                const clientId = newClientRef.key;
                
                await set(newClientRef, {
                    date, name, eventName, phone,
                    totalSize: batchSize,
                    totalImages: fileInput.files.length,
                    createdAt: Date.now()
                });

                await processAndUploadFiles(fileInput.files, clientId, 'uploadProgressBar', 'currentUploadFile', 'uploadPercent');

                document.getElementById('addClientForm').reset();
                document.getElementById('uploadProgressBox').style.display = 'none';
                bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();
                showToast("Event Created Successfully!", "success");
            } catch (error) { 
                showToast("Error: " + error.message, "danger");
            }
            document.getElementById('btnSaveClient').disabled = false;
        };

        window.triggerAddMore = (clientId, clientName) => {
            activeAddClientId = clientId;
            document.getElementById('addMoreClientName').innerText = clientName;
            document.getElementById('addMoreInput').value = '';
            document.getElementById('addMoreCountLabel').innerText = '';
            document.getElementById('addMoreProgressBox').style.display = 'none';
            document.getElementById('btnAddMoreConfirm').disabled = true;
            addMoreModalInstance.show();
        };

        window.confirmAddMore = async () => {
            const fileInput = document.getElementById('addMoreInput');
            document.getElementById('btnAddMoreConfirm').disabled = true;
            document.getElementById('addMoreProgressBox').style.display = 'block';

            let newSize = 0;
            Array.from(fileInput.files).forEach(f => newSize += f.size);

            await processAndUploadFiles(fileInput.files, activeAddClientId, 'addMoreProgressBar', 'addMoreClientName', 'addMoreCountLabel');

            await runTransaction(ref(db, `clients/${activeAddClientId}`), (data) => {
                if (data) {
                    data.totalSize = (data.totalSize || 0) + newSize;
                    data.totalImages = (data.totalImages || 0) + fileInput.files.length;
                }
                return data;
            });

            addMoreModalInstance.hide();
            showToast("Photos added successfully!", "success");
        };

        // NEW: Trigger Delete Modal
        window.prepareDelete = (id) => {
            clientToDeleteId = id;
            deleteModalInstance.show();
        };

        // NEW: Perform Delete Logic
        async function performDelete(id) {
            try {
                const prefix = `gallery_photos/${id}`;
                await fetch(`${WORKER_URL}?prefix=${encodeURIComponent(prefix)}`, {
                        method: 'DELETE'
                });
                
                await remove(ref(db, `clients/${id}`));
                await remove(ref(db, `gallery_photos/${id}`));
                showToast("Event deleted successfully.", "success");
            } catch(e) {
                showToast("Error deleting files: " + e.message, "danger");
            }
        };

        window.triggerEdit = async (id) => {
            const snap = await get(ref(db, `clients/${id}`));
            const data = snap.val();
            document.getElementById('editClientId').value = id;
            document.getElementById('editClientName').value = data.name;
            document.getElementById('editEventName').value = data.eventName;
            document.getElementById('editClientDate').value = data.date;
            document.getElementById('editClientPhone').value = data.phone;
            editClientModalInstance.show();
        };

        window.updateClient = async () => {
            const id = document.getElementById('editClientId').value;
            await update(ref(db, `clients/${id}`), {
                name: document.getElementById('editClientName').value,
                eventName: document.getElementById('editEventName').value,
                date: document.getElementById('editClientDate').value,
                phone: document.getElementById('editClientPhone').value
            });
            editClientModalInstance.hide();
            showToast("Event updated successfully!", "success");
        };

        window.viewClientGallery = (id) => {
            document.getElementById('viewClientId').innerText = id;
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '<div class="text-center w-100 py-4"><div class="spinner-border text-accent"></div></div>';
            new bootstrap.Modal(document.getElementById('viewGalleryModal')).show();
            
            get(ref(db, `gallery_photos/${id}`)).then(snap => {
                grid.innerHTML = '';
                if(snap.exists()) {
                    Object.values(snap.val()).forEach(p => {
                        const img = document.createElement('img');
                        img.src = p.url;
                        img.className = 'gallery-img';
                        grid.appendChild(img);
                    });
                } else grid.innerHTML = '<p class="text-center w-100 py-3">No photos.</p>';
            });
        };

        window.copyToClipboard = (t) => navigator.clipboard.writeText(t).then(() => showToast("Link copied to clipboard!", "success"));

    </script>
</body>
</html>
